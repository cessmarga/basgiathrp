<!DOCTYPE html>
<html>
<!-- <head><title>Admin Panel</title>
      <style>
        table, th, td {
            border: 1px solid #444;
            border-collapse: collapse;
            padding: 8px;
        }
        th { background-color: #eee; }
    </style>
</head> -->
<head>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="shortcut icon" type="image/jpg" href="https://files.jcink.net/uploads2/basgiathrp/basgiath.png" />
  <title>Admin Panel</title>
</head>
<body style="background-image: url('https://files.jcink.net/uploads2/basgiathrp/background/minimalizm_art_gory_6.jpg');" class="theme-light">
  <header style="height:100%; padding: 50px">
    <h1><a href="https://basgiathrp-sparring.onrender.com/admin" class="indx">Basgiath</a></h1>
    <div class="subtitle"><span>Where only the bold survive, and even the brave are broken</span></div>
  </header>
      
      <h2>Welcome, Admin</h2>

      <div style="display: flex; gap: 10px; align-items:center; justify-content: space-between; margin-bottom: 10px;">
            <div style="display: flex; gap: 10px;">
                  <form action="{{ url_for('add_user') }}" method="GET">
                    <button type="submit" class="btn btn-success button-large">âž• Add Users</button>
                  </form>
                  <form action="{{ url_for('increment_age') }}" method="POST" onsubmit="return confirm('Are you ABSOLUTELY sure we\'re moving the timeline to the NEXT YEAR?\nLIKE VERY SURE?');">
                    <button type="submit" class="btn btn-danger btn-sm button-large">ðŸ“… Enter the Next Year</button>
                  </form>
            </div>
                  <form action="{{ url_for('admin_logout') }}" method="GET" style="display: inline;">
                      <button type="submit" class="btn btn-secondary button-large">ðŸšª Logout</button>
                  </form>
      </div>
            
      <table class="tablebasic">
        <thead>
            <tr>
                <th>Username</th>
                <th>Group</th>
                <th>Grad</th>
                <th>Leader</th>
                <th>Pre-War</th>
                <th>Frontlines</th>
                <th>Disability</th>
                <th>Age</th>
                <th>Magic</th>
                <th>Fighter</th>
                <th>Attack Modifier</th>
                <th>Attack %</th>
                <th>Defend Modifier</th>
                <th>Defend %</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr data-user-id="{{ user['id'] }}">
                <td>{{ user['username'] }}</td>
                <td>{{ user['member_group'] }}</td>
                <td>{{ 'Yes' if user['graduate'] == 'yes' else 'No' }}</td>
                <td>{{ 'Yes' if user['leadership'] == 'yes' else 'No' }}</td>
                <td>{{ user['pre_war_status'] }}</td>
                <td>{{ 'Yes' if user['frontlines'] == 'yes' else 'No' }}</td> 
                <td>{{ 'Yes' if user['disability'] == 'yes' else 'No' }}</td>
                <td>{{ user['age'] }}</td>
                <td>{{ user['magic_type'] }}</td>
                <td>{{ user['fighter_type'] }}</td>
                <td>{{ user['attack_success'] }}%</td>
                <td>{{ user['attack_odds'] }}%</td>
                <td>{{ user['defend_success'] }}%</td>
                <td>{{ user['defend_odds'] }}%</td>
                <td>
                    <button class="btn btn-primary btn-sm" onclick="makeRowEditable(this)">Edit</button>
                    <form action="{{ url_for('reset_user', user_id=user['id']) }}" method="POST" onsubmit="return confirm('Are you sure you want to reset user to base stats?');">
                      <button type="submit" class="btn btn-danger btn-sm">Reset</button>
                    </form>
                    <form action="{{ url_for('delete_user', user_id=user['id']) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this user?');">
                      <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                    </form>
                 </td>
            </tr>
            {% endfor %}
        </tbody>
      </table>

      <script>
            function makeRowEditable(button) {
                const row = button.closest('tr');
                const userId = row.dataset.userId;
                const cells = row.querySelectorAll('td');
            
                const values = {
                    member_group: cells[1].innerText.trim(),
                    graduate: cells[2].innerText.trim(),
                    leadership: cells[3].innerText.trim(),
                    frontlines: cells[5].innerText.trim(),
                    disability: cells[6].innerText.trim(),
                    magic_type: cells[8].innerText.trim(),
                    fighter_type: cells[9].innerText.trim()
                };
            
                // Replace cells with <select> inputs
                cells[1].innerHTML = buildSelect('member_group', values.member_group, ['Rider', 'Flier', 'Civilian', 'Infantry', 'Healer', 'Scribe', 'Outlier']);
                cells[2].innerHTML = buildSelect('graduate', values.graduate === 'Yes' ? 'yes' : 'no', ['yes', 'no']);
                cells[3].innerHTML = buildSelect('leadership', values.leadership === 'Yes' ? 'yes' : 'no', ['yes', 'no']);
                cells[5].innerHTML = buildSelect('frontlines', values.frontlines === 'Yes' ? 'yes' : 'no', ['yes', 'no']);
                cells[6].innerHTML = buildSelect('disability', values.disability === 'Yes' ? 'yes' : 'no', ['yes', 'no']);
                cells[8].innerHTML = buildSelect('magic_type', values.magic_type, ['Mental', 'Physical', 'Elemental', 'None']);
                cells[9].innerHTML = buildSelect('fighter_type', values.fighter_type, ['Offensive', 'Defensive', 'Balanced', 'Non-combatant']);
            
                // Replace actions cell with Save form (includes hidden inputs for each field)
                cells[14].innerHTML = `
                    <form action="/edit_user/${userId}" method="POST">
                        <input type="hidden" name="member_group" value="">
                        <input type="hidden" name="graduate" value="">
                        <input type="hidden" name="leadership" value="">
                        <input type="hidden" name="frontlines" value="">
                        <input type="hidden" name="disability" value="">
                        <input type="hidden" name="magic_type" value="">
                        <input type="hidden" name="fighter_type" value="">
                        <input type="hidden" name="id" value="${userId}">
                        <button type="submit" class="btn btn-success btn-sm" onclick="copyValuesToForm(this)">Save</button>
                    </form>
                `;
            }
            
            // Helper to build <select> with preselected value
            function buildSelect(name, selectedValue, options) {
                return `<select name="${name}" class="forminput">
                    ${options.map(opt => `<option value="${opt}" ${opt === selectedValue ? 'selected' : ''}>${opt}</option>`).join('')}
                </select>`;
            }
            
            // This function syncs <select> values into hidden inputs before form submit
            function copyValuesToForm(button) {
                const form = button.closest('form');
                const row = button.closest('tr');
            
                const selects = row.querySelectorAll('select');
                selects.forEach(select => {
                    const hiddenInput = form.querySelector(`input[name="${select.name}"]`);
                    if (hiddenInput) {
                        hiddenInput.value = select.value;
                    }
                });
            }
            </script>
</body>
</html>
